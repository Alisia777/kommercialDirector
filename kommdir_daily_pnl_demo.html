<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ö–æ–º–º–¥–∏—Ä ¬∑ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–ª–∞–Ω–∞ –∏ –º–∞—Ä–∂–∏ –ø–æ SKU (–¥–µ–º–æ)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      /* –ò–º–ø–µ—Ä—Å–∫–∞—è —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞ */
      --bg: #020617;
      --bg-soft: #050b1f;
      --card-bg: #020617;
      --border: #293548;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --accent: #fbbf24;
      --accent-soft: rgba(251, 191, 36, 0.12);
      --danger: #f97373;
      --success: #4ade80;
      --radius-lg: 16px;
      --radius-md: 10px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.65);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 24px 16px 32px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top left, #0b1120 0, #020617 55%, #000 100%);
      color: var(--text-main);
    }

    .page {
      max-width: 1180px;
      margin: 0 auto;
    }

    header {
      margin-bottom: 18px;
    }

    h1 {
      font-size: 26px;
      font-weight: 650;
      margin: 8px 0 4px;
    }

    .subtitle {
      margin: 0 0 18px;
      font-size: 13px;
      color: var(--text-muted);
      max-width: 640px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px 6px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.18), rgba(15, 23, 42, 0.9));
      color: var(--accent);
      font-weight: 500;
      border: 1px solid rgba(248, 250, 252, 0.15);
      backdrop-filter: blur(10px);
    }

    .badge-fox {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 30% 20%, #fef9c3 0, #f97316 55%, #7c2d12 100%);
      box-shadow: 0 0 0 1px rgba(15,23,42,0.5);
      font-size: 14px;
    }

    .badge-sep {
      width: 1px;
      height: 16px;
      background: rgba(248, 250, 252, 0.25);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 18px;
      align-items: flex-start;
    }

    @media (max-width: 960px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: radial-gradient(circle at top left, #0f172a 0, #020617 55%);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 14px 16px 16px;
      margin-bottom: 14px;
      border: 1px solid rgba(148, 163, 184, 0.28);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
    }

    .card-caption {
      font-size: 12px;
      color: var(--text-muted);
    }

    .pill {
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--text-muted);
      white-space: nowrap;
      background: rgba(15, 23, 42, 0.8);
    }

    .pill-strong {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-soft);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 12px;
    }

    .form-row {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 12px;
    }

    label {
      font-size: 12px;
      color: var(--text-muted);
    }

    input[type="text"],
    select {
      padding: 6px 7px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.45);
      font-size: 12px;
      width: 100%;
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      outline: none;
      transition: border-color 0.12s ease-out, box-shadow 0.12s ease-out, background 0.12s;
    }

    input[type="text"]::placeholder,
    select::placeholder {
      color: rgba(148, 163, 184, 0.8);
    }

    input[type="text"]:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(251, 191, 36, 0.35);
      background: #020617;
    }

    .form-row-inline {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }

    .form-row-inline input[type="checkbox"] {
      transform: translateY(1px);
    }

    .hint {
      font-size: 11px;
      color: var(--text-muted);
    }

    .btn-primary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 18px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #fbbf24, #f97316);
      color: #111827;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
      box-shadow: 0 10px 25px rgba(251, 191, 36, 0.45);
      letter-spacing: 0.01em;
    }

    .btn-primary:hover {
      filter: brightness(1.05);
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 6px 16px rgba(251, 191, 36, 0.4);
    }

    .btn-secondary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 5px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-muted);
      font-size: 11px;
      cursor: pointer;
    }

    .btn-secondary:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .btn-secondary:active {
      transform: translateY(1px);
    }

    .output-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px 12px;
      margin-top: 6px;
    }

    .output-row {
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .output-label {
      color: var(--text-muted);
    }

    .output-value {
      font-weight: 600;
    }

    .output-value.bad {
      color: var(--danger);
    }

    .output-value.good {
      color: var(--success);
    }

    .small-note {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 11px;
      margin-top: 4px;
      color: var(--text-muted);
    }

    .chip {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.65);
      background: rgba(15, 23, 42, 0.9);
    }

    .highlight {
      font-weight: 600;
      color: var(--accent);
    }

    .mono {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
  </style>
</head>
<body>
<div class="page">
  <header>
    <div class="badge">
      <span class="badge-fox">ü¶ä</span>
      <span>–ö–æ–º–º–¥–∏—Ä ¬∑ –º–∏–Ω–∏-–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä P&amp;L –ø–æ SKU</span>
      <span class="badge-sep"></span>
      <span>–¥–µ–º–æ-–≤–µ—Ä—Å–∏—è</span>
    </div>
    <h1>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–ª–∞–Ω–∞ –ø–æ SKU</h1>
    <p class="subtitle">
      –í–Ω–µ—Å–∏—Ç–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø—Ä–æ—à–ª—ã–µ –º–µ—Å—è—Ü—ã –∏–ª–∏ –ø–æ–¥—Ç—è–Ω–∏—Ç–µ –∏—Ö –∏–∑ CSV, –∑–∞–¥–∞–π—Ç–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –º–µ—Å—è—Ü–∞ ‚Äî
      –∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–æ—Å—á–∏—Ç–∞–µ—Ç –ø–ª–∞–Ω —à—Ç—É–∫, –æ–±–æ—Ä–æ—Ç –∏ –º–∞—Ä–∂—É –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ç–æ–≤–∞—Ä—É.
    </p>
  </header>

  <main class="layout">
    <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: –≤–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö -->
    <section>
      <form id="planner-form" onsubmit="event.preventDefault(); calculatePlan();">
        <!-- –ë–ª–æ–∫: –æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">1. –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
              <div class="card-caption">SKU, –ø–ª–æ—â–∞–¥–∫–∞ –∏ —Ü–µ–ª–µ–≤–æ–π –º–µ—Å—è—Ü –ø–ª–∞–Ω–∞.</div>
            </div>
            <div class="pill">Step 1</div>
          </div>
          <div class="form-grid">
            <div class="form-row">
              <label for="skuName">SKU / –ú–æ–¥–µ–ª—å</label>
              <input type="text" id="skuName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: SKU-1234 / –¢–æ–≤–∞—Ä A">
            </div>
            <div class="form-row">
              <label for="cabinet">–ö–∞–±–∏–Ω–µ—Ç / —é—Ä–ª–∏—Ü–æ</label>
              <input type="text" id="cabinet" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–ü –ò–≤–∞–Ω–æ–≤ / –û–û–û ¬´–ü—Ä–∏–º–µ—Ä¬ª">
            </div>
            <div class="form-row">
              <label for="marketplace">–ü–ª–æ—â–∞–¥–∫–∞</label>
              <select id="marketplace">
                <option value="WB">Wildberries</option>
                <option value="OZON">Ozon</option>
                <option value="Both">WB + Ozon (—Å–æ–≤–æ–∫—É–ø–Ω–æ)</option>
              </select>
            </div>
            <div class="form-row">
              <label for="targetMonth">–¶–µ–ª–µ–≤–æ–π –º–µ—Å—è—Ü (–Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç—á—ë—Ç–∞)</label>
              <input type="text" id="targetMonth" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –î–µ–∫–∞–±—Ä—å 2025">
            </div>
          </div>
        </div>

        <!-- –ë–ª–æ–∫: –∏—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–¥–∞–∂ -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">2. –ò—Å—Ç–æ—Ä–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞</div>
              <div class="card-caption">
                –ú–æ–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ —Ä—É–∫–∞–º–∏ –∏–ª–∏ –ø–æ–¥—Ç—è–Ω—É—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ CSV —Å –∏—Å—Ç–æ—Ä–∏–µ–π –ø—Ä–æ–¥–∞–∂.
              </div>
            </div>
            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
              <div class="pill">Step 2</div>
              <button type="button" class="btn-secondary" onclick="prefillFromHistory()">
                –ò–∑ –∏—Å—Ç–æ—Ä–∏–∏ CSV
              </button>
            </div>
          </div>
          <div class="form-grid">
            <div class="form-row">
              <label>–ú–µ—Å—è—Ü ‚àí3 (—Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π)</label>
              <input type="text" id="m1Name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–µ–Ω—Ç—è–±—Ä—å">
              <div class="form-row">
                <label for="m1Units">–ü—Ä–æ–¥–∞–Ω–æ, —à—Ç</label>
                <input type="text" id="m1Units" placeholder="—à—Ç">
              </div>
              <div class="form-row">
                <label for="m1Revenue">–í—ã—Ä—É—á–∫–∞ –ø–æ—Å–ª–µ –°–ü–ü, ‚ÇΩ (–æ–ø—Ü.)</label>
                <input type="text" id="m1Revenue" placeholder="–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º">
              </div>
            </div>
            <div class="form-row">
              <label>–ú–µ—Å—è—Ü ‚àí2</label>
              <input type="text" id="m2Name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û–∫—Ç—è–±—Ä—å">
              <div class="form-row">
                <label for="m2Units">–ü—Ä–æ–¥–∞–Ω–æ, —à—Ç</label>
                <input type="text" id="m2Units" placeholder="—à—Ç">
              </div>
              <div class="form-row">
                <label for="m2Revenue">–í—ã—Ä—É—á–∫–∞ –ø–æ—Å–ª–µ –°–ü–ü, ‚ÇΩ (–æ–ø—Ü.)</label>
                <input type="text" id="m2Revenue" placeholder="–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º">
              </div>
            </div>
            <div class="form-row">
              <label>–ú–µ—Å—è—Ü ‚àí1 (–ø–æ—Å–ª–µ–¥–Ω–∏–π —Ñ–∞–∫—Ç)</label>
              <input type="text" id="m3Name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ù–æ—è–±—Ä—å">
              <div class="form-row">
                <label for="m3Units">–ü—Ä–æ–¥–∞–Ω–æ, —à—Ç</label>
                <input type="text" id="m3Units" placeholder="—à—Ç">
              </div>
              <div class="form-row">
                <label for="m3Revenue">–í—ã—Ä—É—á–∫–∞ –ø–æ—Å–ª–µ –°–ü–ü, ‚ÇΩ (–æ–ø—Ü.)</label>
                <input type="text" id="m3Revenue" placeholder="–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º">
              </div>
            </div>
            <div class="form-row">
              <label>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏</label>
              <div class="form-row-inline">
                <input type="checkbox" id="isNew">
                <label for="isNew">–ù–æ–≤–∏–Ω–∫–∞ (–Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏, –ø–ª–∞–Ω –∑–∞–¥–∞—ë–º —Ä—É–∫–∞–º–∏)</label>
              </div>
              <div class="form-row">
                <label for="manualBaseUnits">–ï—Å–ª–∏ –Ω–æ–≤–∏–Ω–∫–∞: –±–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω, —à—Ç</label>
                <input type="text" id="manualBaseUnits" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 30">
                <div class="hint">–ï—Å–ª–∏ –Ω–µ –Ω–æ–≤–∏–Ω–∫–∞, —ç—Ç–æ –ø–æ–ª–µ –º–æ–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å.</div>
              </div>
            </div>
          </div>
          <p class="small-note">
            CSV –∏—â–µ—Ç—Å—è –ø–æ —Å–≤—è–∑–∫–µ: <span class="mono">cabinet + mp + sku</span>,
            –≥–¥–µ mp = WB / OZON / Both (–¥–ª—è Both —Å—É–º–º–∏—Ä—É—é—Ç—Å—è –æ–±–µ –ø–ª–æ—â–∞–¥–∫–∏).
          </p>
        </div>

        <!-- –ë–ª–æ–∫: –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –º–µ—Å—è—Ü–∞ –∏ —Å—Ü–µ–Ω–∞—Ä–∏–π -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">3. –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –º–µ—Å—è—Ü–∞ –∏ —Å—Ü–µ–Ω–∞—Ä–∏–π</div>
              <div class="card-caption">
                –°–µ–∑–æ–Ω–Ω–æ—Å—Ç—å –∏ —Å—Ü–µ–Ω–∞—Ä–∏–π (–±–∞–∑–∞ / –æ–ø—Ç–∏–º–∏—Å—Ç / –ø–µ—Å—Å–∏–º–∏—Å—Ç), –ø–ª—é—Å —Ä—É—á–Ω–æ–π –æ–≤–µ—Ä—Ä–∞–π–¥ –ø–ª–∞–Ω–∞ —à—Ç—É–∫.
              </div>
            </div>
            <div class="pill">Step 3</div>
          </div>
          <div class="form-grid">
            <div class="form-row">
              <label for="kSeason">K —Å–µ–∑–æ–Ω–∞ –¥–ª—è —Ü–µ–ª–µ–≤–æ–≥–æ –º–µ—Å—è—Ü–∞</label>
              <input type="text" id="kSeason" placeholder="1 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é">
              <div class="hint">
                –ù–∞–ø—Ä–∏–º–µ—Ä: 1.2 –¥–ª—è –¥–µ–∫–∞–±—Ä—è, 0.8 –¥–ª—è ¬´—Å–ª–∞–±–æ–≥–æ¬ª –º–µ—Å—è—Ü–∞.
              </div>
            </div>
            <div class="form-row">
              <label for="kScenario">K —Å—Ü–µ–Ω–∞—Ä–∏—è (–ë–∞–∑–∞ / –û–ø—Ç / –ü–µ—Å—Å–∏–º)</label>
              <input type="text" id="kScenario" value="1">
              <div class="hint">1 ‚Äî –±–∞–∑–æ–≤—ã–π; 1.1 ‚Äî –æ–ø—Ç–∏–º–∏—Å—Ç; 0.85 ‚Äî –ø–µ—Å—Å–∏–º–∏—Å—Ç.</div>
            </div>
            <div class="form-row">
              <label for="planUnitsOverride">–†—É—á–Ω–æ–π –ø–ª–∞–Ω, —à—Ç (–æ–≤–µ—Ä—Ä–∞–π–¥)</label>
              <input type="text" id="planUnitsOverride" placeholder="–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –¥–æ–≤–µ—Ä—è–µ—Ç–µ —Ñ–æ—Ä–º—É–ª–µ">
              <div class="hint">–ï—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å ‚Äî –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤–æ–∑—å–º—ë—Ç —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ –∞–≤—Ç–æ—Ä–∞—Å—á—ë—Ç–∞.</div>
            </div>
          </div>
        </div>

        <!-- –ë–ª–æ–∫: —Ü–µ–Ω–∞, –°–ü–ü, –∑–∞—Ç—Ä–∞—Ç—ã -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">4. –¶–µ–Ω–∞, –°–ü–ü –∏ –∑–∞—Ç—Ä–∞—Ç—ã –ø–æ SKU</div>
              <div class="card-caption">
                –≠—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–≤—Ç–æ—Ä—è—é—Ç –ª–æ–≥–∏–∫—É P&amp;L / BI –ø–æ –µ–¥–∏–Ω–∏—Ü–µ —Ç–æ–≤–∞—Ä–∞.
              </div>
            </div>
            <div class="pill">Step 4</div>
          </div>
          <div class="form-grid">
            <div class="form-row">
              <label for="priceGross">–¶–µ–Ω–∞ –¥–æ –°–ü–ü, ‚ÇΩ</label>
              <input type="text" id="priceGross" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 4 490">
            </div>
            <div class="form-row">
              <label for="sppPercent">–°–ü–ü / —Å–∫–∏–¥–∫–∞, %</label>
              <input type="text" id="sppPercent" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 15">
            </div>
            <div class="form-row">
              <label for="cogs">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å, ‚ÇΩ/–µ–¥</label>
              <input type="text" id="cogs" placeholder="–∑–∞–∫—É–ø–∫–∞ + –¥–æ—Å—Ç–∞–≤–∫–∞ –¥–æ –†–§">
            </div>
            <div class="form-row">
              <label for="logStock">–õ–æ–≥–∏—Å—Ç–∏–∫–∞ –¥–æ —Å–∫–ª–∞–¥–∞, ‚ÇΩ/–µ–¥</label>
              <input type="text" id="logStock" placeholder="—Å—Ä–µ–¥–Ω—è—è —Å—Ç–∞–≤–∫–∞">
            </div>
            <div class="form-row">
              <label for="logClient">–õ–æ–≥–∏—Å—Ç–∏–∫–∞ –¥–æ –∫–ª–∏–µ–Ω—Ç–∞, ‚ÇΩ/–µ–¥</label>
              <input type="text" id="logClient" placeholder="FBO/FBS">
            </div>
            <div class="form-row">
              <label for="storageCost">–•—Ä–∞–Ω–µ–Ω–∏–µ, ‚ÇΩ/–µ–¥</label>
              <input type="text" id="storageCost" placeholder="–≤ –º–µ—Å—è—Ü">
            </div>
            <div class="form-row">
              <label for="otherVar">–ü—Ä–æ—á–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, ‚ÇΩ/–µ–¥</label>
              <input type="text" id="otherVar" placeholder="—É–ø–∞–∫–æ–≤–∫–∞, —É—Å–ª—É–≥–∏, —Å—Ä–µ–¥–Ω–∏–µ —à—Ç—Ä–∞—Ñ—ã">
            </div>
            <div class="form-row">
              <label for="commissionPercent">–ö–æ–º–∏—Å—Å–∏—è –ú–ü, %</label>
              <input type="text" id="commissionPercent" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 15">
            </div>
            <div class="form-row">
              <label for="returnsPercent">–í–æ–∑–≤—Ä–∞—Ç—ã, % –æ—Ç –≤—ã—Ä—É—á–∫–∏</label>
              <input type="text" id="returnsPercent" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 5">
            </div>
            <div class="form-row">
              <label for="defectPercent">–ë—Ä–∞–∫, % –ø–æ —à—Ç—É–∫–∞–º</label>
              <input type="text" id="defectPercent" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 2">
            </div>
            <div class="form-row">
              <label for="drrPercent">–ü–ª–∞–Ω–æ–≤—ã–π –î–†–†, %</label>
              <input type="text" id="drrPercent" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 20">
            </div>
            <div class="form-row">
              <label for="taxPercent">–ù–∞–ª–æ–≥, % –æ—Ç –ø—Ä–∏–±—ã–ª–∏</label>
              <input type="text" id="taxPercent" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 6">
            </div>
          </div>

          <button type="submit" class="btn-primary">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø–ª–∞–Ω –∏ –º–∞—Ä–∂—É</button>
          <p class="small-note">
            –í—Å–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –≤–≤–æ–¥–∏–º –∫–∞–∫ <span class="mono">15</span> = 15%, –∞ –Ω–µ 0.15.
            –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–ª—è —á–∏—Å–µ–ª ‚Äî —Ç–æ—á–∫–∞ –∏–ª–∏ –∑–∞–ø—è—Ç–∞—è, –ø—Ä–æ–±–µ–ª—ã –º–æ–∂–Ω–æ.
          </p>
        </div>
      </form>
    </section>

    <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ -->
    <aside>
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">–ò—Ç–æ–≥–∏ –ø–æ SKU –Ω–∞ –º–µ—Å—è—Ü</div>
            <div class="card-caption">
              –ü–ª–∞–Ω —à—Ç—É–∫, –æ–±–æ—Ä–æ—Ç –∏ –º–∞—Ä–∂–∞ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ç–æ–≤–∞—Ä—É –∏ –º–µ—Å—è—Ü—É.
            </div>
          </div>
          <div class="pill-strong">Result</div>
        </div>

        <div class="chip-row">
          <div class="chip">
            –ë–∞–∑–∞, —à—Ç: <span id="baseUnitsInfo" class="mono">0</span>
          </div>
          <div class="chip">
            K —Ç—Ä–µ–Ω–¥–∞: <span id="trendInfo" class="mono">1.00</span>
          </div>
          <div class="chip">
            –ò—Ç–æ–≥–æ–≤—ã–π K: <span id="totalKInfo" class="mono">1.00</span>
          </div>
          <div class="chip">
            –ù–æ–≤–∏–Ω–∫–∞: <span id="isNewInfo" class="mono">–Ω–µ—Ç</span>
          </div>
        </div>

        <div class="output-grid" style="margin-top:10px;">
          <div class="output-row">
            <div class="output-label">–ü–ª–∞–Ω –ø—Ä–æ–¥–∞–∂, —à—Ç</div>
            <div class="output-value" id="outPlanUnits">0</div>
          </div>
          <div class="output-row">
            <div class="output-label">–í—ã—Ä—É—á–∫–∞ –¥–æ –°–ü–ü, ‚ÇΩ</div>
            <div class="output-value" id="outRevenueGross">0</div>
          </div>
          <div class="output-row">
            <div class="output-label">–í—ã—Ä—É—á–∫–∞ –ø–æ—Å–ª–µ –°–ü–ü –∏ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤, ‚ÇΩ</div>
            <div class="output-value" id="outRevenueNet">0</div>
          </div>
          <div class="output-row">
            <div class="output-label">–†–∞—Å—Ö–æ–¥ –Ω–∞ —Ä–µ–∫–ª–∞–º—É, ‚ÇΩ</div>
            <div class="output-value" id="outAdSpend">0</div>
          </div>
          <div class="output-row">
            <div class="output-label">–ú–∞—Ä–∂–∞, ‚ÇΩ</div>
            <div class="output-value" id="outProfit">0</div>
          </div>
          <div class="output-row">
            <div class="output-label">–ú–∞—Ä–∂–∞, % –æ—Ç –≤—ã—Ä—É—á–∫–∏</div>
            <div class="output-value" id="outMarginPercent">0%</div>
          </div>
          <div class="output-row">
            <div class="output-label">–ú–∞—Ä–∂–∞, ‚ÇΩ/–µ–¥</div>
            <div class="output-value" id="outProfitPerUnit">0</div>
          </div>
          <div class="output-row">
            <div class="output-label">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –î–†–† –ø–æ –ø–ª–∞–Ω—É</div>
            <div class="output-value" id="outRealDRR">0%</div>
          </div>
        </div>

        <p class="small-note">
          –ï—Å–ª–∏ –º–∞—Ä–∂–∞ –≤ % –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç—Å—è –∫—Ä–∞—Å–Ω—ã–º ‚Äî –Ω–∏–∂–µ 0 –∏–ª–∏ —Å–æ–≤—Å–µ–º ¬´—Ç–æ–Ω–∫–∞—è¬ª.
          –ú–æ–∂–Ω–æ –∏–≥—Ä–∞—Ç—å—Å—è —Ü–µ–Ω–æ–π, K —Å–µ–∑–æ–Ω–∞, –î–†–† –∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–∏.
        </p>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">–§–æ—Ä–º—É–ª–∞ –ø–ª–∞–Ω–∞ —à—Ç—É–∫</div>
            <div class="card-caption">–ö–∞–∫ –∏–º–µ–Ω–Ω–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–ª–∞–Ω –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É.</div>
          </div>
          <div class="pill">Logic</div>
        </div>
        <p class="small-note">
          –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä –Ω–µ –Ω–æ–≤–∏–Ω–∫–∞:
        </p>
        <p class="small-note mono">
          –ë–∞–∑–∞_—à—Ç = —Å—Ä–µ–¥–Ω–µ–µ(—à—Ç_–º‚àí3, —à—Ç_–º‚àí2, —à—Ç_–º‚àí1)<br>
          K_—Ç—Ä–µ–Ω–¥–∞ = —à—Ç_–º‚àí1 / —à—Ç_–º‚àí2 (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω 0.6‚Ä¶1.4)<br>
          –ü–ª–∞–Ω_—à—Ç_–∞–≤—Ç–æ = –ë–∞–∑–∞_—à—Ç √ó K_—Ç—Ä–µ–Ω–¥–∞ √ó K_—Å–µ–∑–æ–Ω–∞ √ó K_—Å—Ü–µ–Ω–∞—Ä–∏—è
        </p>
        <p class="small-note">
          –ï—Å–ª–∏ —Å—Ç–æ–∏—Ç –≥–∞–ª–æ—á–∫–∞ ¬´–ù–æ–≤–∏–Ω–∫–∞¬ª ‚Äî –ë–∞–∑–∞_—à—Ç –±–µ—Ä—ë—Ç—Å—è –∏–∑ –ø–æ–ª—è
          ¬´–±–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω, —à—Ç¬ª, –±–µ–∑ —É—á—ë—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏, K —Ç—Ä–µ–Ω–¥–∞ = 1.
        </p>
        <p class="small-note">
          –ü–æ–ª–µ ¬´–†—É—á–Ω–æ–π –ø–ª–∞–Ω, —à—Ç¬ª –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç, –µ—Å–ª–∏ —Ç–∞–º –Ω–µ –ø—É—Å—Ç–æ.
        </p>
      </div>
    </aside>
  </main>
</div>

<script>
  // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑ CSV ---
  let historyData = [];
  let historyLoaded = false;

  function parseNumber(value) {
    if (!value) return 0;
    value = String(value).replace(/\s+/g, "").replace(",", ".");
    const num = parseFloat(value);
    return isNaN(num) ? 0 : num;
  }

  function parsePercentInput(id) {
    const v = parseNumber(document.getElementById(id).value);
    return v / 100.0;
  }

  function formatNumber(value, decimals) {
    if (!isFinite(value)) value = 0;
    decimals = decimals === undefined ? 0 : decimals;
    const options = {
      minimumFractionDigits: decimals,
      maximumFractionDigits: decimals
    };
    return value.toLocaleString("ru-RU", options);
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ CSV —Å –∏—Å—Ç–æ—Ä–∏–µ–π
  function loadHistoryCsv() {
    fetch("data/xgrow_history.csv")
      .then(resp => {
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        return resp.text();
      })
      .then(text => {
        const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0);
        if (lines.length <= 1) return;

        const header = lines[0].split(";");
        const idxCabinet = header.indexOf("cabinet");
        const idxMp = header.indexOf("mp");
        const idxSku = header.indexOf("sku");
        const idxMonth = header.indexOf("month");
        const idxUnits = header.indexOf("units");
        const idxRevenue = header.indexOf("revenue_net");
        const idxKSeasonNext = header.indexOf("k_season_next");

        historyData = lines.slice(1).map(line => {
          const cols = line.split(";");
          return {
            cabinet: (cols[idxCabinet] || "").trim(),
            mp: (cols[idxMp] || "").trim(),
            sku: (cols[idxSku] || "").trim(),
            month: (cols[idxMonth] || "").trim(), // —Ñ–æ—Ä–º–∞—Ç YYYY-MM
            units: parseNumber(cols[idxUnits] || ""),
            revenueNet: parseNumber(cols[idxRevenue] || ""),
            kSeasonNext: idxKSeasonNext >= 0 ? parseNumber(cols[idxKSeasonNext] || "") : 0
          };
        });

        historyLoaded = true;
        console.log("–ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞, —Å—Ç—Ä–æ–∫:", historyData.length);
      })
      .catch(err => {
        console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å data/xgrow_history.csv:", err);
      });
  }

  // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑ CSV
  function prefillFromHistory() {
    if (!historyLoaded || historyData.length === 0) {
      alert("–ò—Å—Ç–æ—Ä–∏—è –∏–∑ CSV –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–ª–∏ —Ñ–∞–π–ª –ø—É—Å—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ data/xgrow_history.csv –¥–æ—Å—Ç—É–ø–µ–Ω.");
      return;
    }

    const cabinet = document.getElementById("cabinet").value.trim();
    const mp = document.getElementById("marketplace").value;
    const sku = document.getElementById("skuName").value.trim();

    if (!cabinet || !sku) {
      alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è ¬´SKU / –ú–æ–¥–µ–ª—å¬ª –∏ ¬´–ö–∞–±–∏–Ω–µ—Ç / —é—Ä–ª–∏—Ü–æ¬ª, —á—Ç–æ–±—ã –ø–æ–∏—Å–∫–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ CSV.");
      return;
    }

    let filtered = historyData.filter(row =>
      row.cabinet === cabinet &&
      row.sku === sku
    );

    if (mp !== "Both") {
      filtered = filtered.filter(row => row.mp === mp);
    }

    if (filtered.length === 0) {
      alert("–í CSV –Ω–µ –Ω–∞–π–¥–µ–Ω—ã —Å—Ç—Ä–æ–∫–∏ —Å —Ç–∞–∫–∏–º –∫–∞–±–∏–Ω–µ—Ç–æ–º / SKU / –ø–ª–æ—â–∞–¥–∫–æ–π.");
      return;
    }

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –º–µ—Å—è—Ü—É –∏ –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3
    filtered.sort((a, b) => a.month.localeCompare(b.month));
    const last3 = filtered.slice(-3);

    // –û—á–∏—â–∞–µ–º —Å–Ω–∞—á–∞–ª–∞ –ø–æ–ª—è
    ["m1Name","m2Name","m3Name","m1Units","m2Units","m3Units","m1Revenue","m2Revenue","m3Revenue"]
      .forEach(id => document.getElementById(id).value = "");

    function setMonthFields(pos, row) {
      const nameId = "m" + pos + "Name";
      const unitsId = "m" + pos + "Units";
      const revId = "m" + pos + "Revenue";
      document.getElementById(nameId).value = row.month;
      document.getElementById(unitsId).value = row.units > 0 ? row.units : "";
      if (row.revenueNet > 0) {
        document.getElementById(revId).value = row.revenueNet;
      }
    }

    // –∑–∞–ø–æ–ª–Ω—è–µ–º –Ω–∞—á–∏–Ω–∞—è —Å —Å–∞–º–æ–≥–æ —Å—Ç–∞—Ä–æ–≥–æ –∏–∑ last3
    const startPos = 4 - last3.length; // –ø—Ä–∏ 1 —Å—Ç—Ä–æ–∫–µ –æ–Ω–∞ –≤ m3, –ø—Ä–∏ 2 ‚Äî m2/m3, –ø—Ä–∏ 3 ‚Äî m1/m2/m3
    last3.forEach((row, idx) => {
      setMonthFields(startPos + idx, row);
    });

    // K —Å–µ–∑–æ–Ω–∞ –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –∏–∑ k_season_next –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –º–µ—Å—è—Ü–∞
    const lastRow = last3[last3.length - 1];
    if (lastRow && lastRow.kSeasonNext > 0) {
      document.getElementById("kSeason").value = lastRow.kSeasonNext;
    }
  }

  function calculatePlan() {
    // –ò—Å—Ç–æ—Ä–∏—è
    const isNew = document.getElementById("isNew").checked;
    const m1Units = parseNumber(document.getElementById("m1Units").value);
    const m2Units = parseNumber(document.getElementById("m2Units").value);
    const m3Units = parseNumber(document.getElementById("m3Units").value);

    let baseUnits = 0;
    let trendK = 1;

    if (!isNew) {
      const hist = [m1Units, m2Units, m3Units].filter(v => v > 0);
      if (hist.length > 0) {
        const sum = hist.reduce((a, b) => a + b, 0);
        baseUnits = sum / hist.length;
      }
      if (m2Units > 0 && m3Units > 0) {
        trendK = m3Units / m2Units;
        if (trendK < 0.6) trendK = 0.6;
        if (trendK > 1.4) trendK = 1.4;
      }
    } else {
      baseUnits = parseNumber(document.getElementById("manualBaseUnits").value);
      trendK = 1;
    }

    let kSeason = parseNumber(document.getElementById("kSeason").value || "1");
    if (kSeason <= 0) kSeason = 1;
    let kScenario = parseNumber(document.getElementById("kScenario").value || "1");
    if (kScenario <= 0) kScenario = 1;

    const totalK = trendK * kSeason * kScenario;

    const planUnitsAuto = baseUnits * totalK;
    const planUnitsOverride = parseNumber(document.getElementById("planUnitsOverride").value);
    let planUnits = planUnitsOverride > 0 ? planUnitsOverride : Math.round(planUnitsAuto);
    if (!isFinite(planUnits) || planUnits < 0) planUnits = 0;

    // –¶–µ–Ω–∞ –∏ –ø—Ä–æ—Ü–µ–Ω—Ç—ã
    const priceGross = parseNumber(document.getElementById("priceGross").value);
    const spp = parsePercentInput("sppPercent");
    const cogs = parseNumber(document.getElementById("cogs").value);
    const logStock = parseNumber(document.getElementById("logStock").value);
    const logClient = parseNumber(document.getElementById("logClient").value);
    const storageCost = parseNumber(document.getElementById("storageCost").value);
    const otherVar = parseNumber(document.getElementById("otherVar").value);
    const commissionP = parsePercentInput("commissionPercent");
    const returnsP = parsePercentInput("returnsPercent");
    const defectP = parsePercentInput("defectPercent");
    const drrP = parsePercentInput("drrPercent");
    const taxP = parsePercentInput("taxPercent");

    // –ü–ª–∞–Ω—ã –ø–æ –≤—ã—Ä—É—á–∫–µ
    const revenueGross = planUnits * priceGross;
    const sppRub = revenueGross * spp;
    const revenueAfterSPP = revenueGross - sppRub;
    const returnsRub = revenueAfterSPP * returnsP;
    const revenueNet = revenueAfterSPP - returnsRub;

    // –ë—Ä–∞–∫ –ø–æ —à—Ç—É–∫–∞–º (—Å–ø–∏—Å—ã–≤–∞–µ–º —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –±—Ä–∞–∫–∞)
    const defectUnits = planUnits * defectP;
    let goodUnits = planUnits - defectUnits;
    if (goodUnits < 0) goodUnits = 0;

    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã
    const cogsTotal = planUnits * cogs;
    const logStockTotal = planUnits * logStock;
    const logClientTotal = planUnits * logClient;
    const storageTotal = planUnits * storageCost;
    const otherVarTotal = planUnits * otherVar;
    const commissionTotal = revenueAfterSPP * commissionP;

    // –í–∞–ª–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å –¥–æ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞
    const grossProfitBeforeMkt =
      revenueNet -
      cogsTotal -
      logStockTotal -
      logClientTotal -
      storageTotal -
      otherVarTotal -
      commissionTotal;

    // –†–µ–∫–ª–∞–º–∞
    const adSpend = revenueNet * drrP;
    const profitBeforeTax = grossProfitBeforeMkt - adSpend;

    // –ù–∞–ª–æ–≥–∏
    const tax = profitBeforeTax * taxP;
    const netProfit = profitBeforeTax - tax;

    // KPI
    const marginPercent = revenueNet > 0 ? (netProfit / revenueNet) * 100 : 0;
    const profitPerUnit = planUnits > 0 ? netProfit / planUnits : 0;
    const realDRR = revenueNet > 0 ? (adSpend / revenueNet) * 100 : 0;

    // –û–±–Ω–æ–≤–ª—è–µ–º UI
    document.getElementById("baseUnitsInfo").textContent = formatNumber(baseUnits, 1);
    document.getElementById("trendInfo").textContent = formatNumber(trendK, 2);
    document.getElementById("totalKInfo").textContent = formatNumber(totalK, 2);
    document.getElementById("isNewInfo").textContent = isNew ? "–¥–∞" : "–Ω–µ—Ç";

    document.getElementById("outPlanUnits").textContent = formatNumber(planUnits, 0);
    document.getElementById("outRevenueGross").textContent = formatNumber(revenueGross, 0);
    document.getElementById("outRevenueNet").textContent = formatNumber(revenueNet, 0);
    document.getElementById("outAdSpend").textContent = formatNumber(adSpend, 0);
    document.getElementById("outProfit").textContent = formatNumber(netProfit, 0);
    document.getElementById("outMarginPercent").textContent = formatNumber(marginPercent, 1) + " %";
    document.getElementById("outProfitPerUnit").textContent = formatNumber(profitPerUnit, 0);
    document.getElementById("outRealDRR").textContent = formatNumber(realDRR, 1) + " %";

    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –º–∞—Ä–∂–∏
    const marginEl = document.getElementById("outMarginPercent");
    marginEl.classList.remove("bad", "good");
    if (marginPercent < 0) {
      marginEl.classList.add("bad");
    } else if (marginPercent >= 20) {
      marginEl.classList.add("good");
    }
  }

  document.addEventListener("DOMContentLoaded", loadHistoryCsv);
</script>
</body>
</html>

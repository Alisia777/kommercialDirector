<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Калькулятор плана и маржи по SKU — Kommdir Systems</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root {
            --bg: #0b0d12;
            --card-bg: rgba(255,255,255,.05);
            --border: rgba(255,255,255,.12);
            --text-main: #eaf0ff;
            --text-muted: #a9b5d4;
            --accent: #6ee7ff;
            --accent-soft: rgba(110,231,255, 0.08);
            --danger: #ff6b6b;
            --success: #34d399;
            --radius-lg: 14px;
            --radius-md: 10px;
            --shadow-soft: 0 20px 60px rgba(0,0,0,.45);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top left, rgba(110,231,255,.14) 0, rgba(7,9,16,1) 40%, var(--bg) 100%);
            color: var(--text-main);
        }

        .page {
            max-width: 1180px;
            margin: 0 auto;
        }

        h1 {
            font-size: 26px;
            margin: 6px 0 2px;
        }

        .subtitle {
            margin: 0 0 18px;
            font-size: 13px;
            color: var(--text-muted);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            background: var(--accent-soft);
            color: var(--accent);
            font-weight: 500;
        }

        .badge-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--accent);
        }

        .layout {
            display: grid;
            grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
            gap: 16px;
            align-items: flex-start;
        }

        @media (max-width: 960px) {
            .layout {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-soft);
            padding: 14px 16px 16px;
            margin-bottom: 12px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .card-title {
            font-size: 15px;
            font-weight: 600;
        }

        .card-caption {
            font-size: 12px;
            color: var(--text-muted);
        }

        .pill {
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 11px;
            border: 1px solid var(--border);
            color: var(--text-muted);
            white-space: nowrap;
        }

        .pill-strong {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-soft);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px 12px;
        }

        .form-row {
            display: flex;
            flex-direction: column;
            gap: 3px;
            font-size: 12px;
        }

        label {
            font-size: 12px;
            color: var(--text-muted);
        }

        input[type="text"],
        select {
            padding: 6px 7px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            font-size: 12px;
            width: 100%;
            background: rgba(255,255,255,.04);
            outline: none;
        }

        input[type="text"]:focus,
        select:focus {
            border-color: var(--accent);
            background: rgba(255,255,255,.06);
        }

        .form-row-inline {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .form-row-inline input[type="checkbox"] {
            transform: translateY(1px);
        }

        .hint {
            font-size: 11px;
            color: var(--text-muted);
        }

        .btn-primary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 7px 16px;
            border-radius: 999px;
            border: none;
            background: var(--accent);
            color: white;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 6px;
        }

        .btn-primary:active {
            transform: translateY(1px);
        }

        .btn-secondary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 5px 12px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,.06);
            color: var(--text-muted);
            font-size: 11px;
            cursor: pointer;
        }

        .btn-secondary:active {
            transform: translateY(1px);
        }

        .output-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 6px 12px;
            margin-top: 6px;
        }

        .output-row {
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }

        .output-label {
            color: var(--text-muted);
        }

        .output-value {
            font-weight: 600;
        }

        .output-value.bad {
            color: var(--danger);
        }

        .output-value.good {
            color: var(--success);
        }

        .small-note {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .chip-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            font-size: 11px;
            margin-top: 4px;
            color: var(--text-muted);
        }

        .chip {
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px solid var(--border);
        }

        .highlight {
            font-weight: 600;
            color: var(--accent);
        }

        .mono {
            font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
    
        .notice{
            margin: 14px 0 0;
            padding: 12px 14px;
            border: 1px solid rgba(110,231,255,.22);
            background: rgba(110,231,255,.08);
            border-radius: var(--radius-lg);
            color: var(--text-main);
        }
        .notice a{ color: var(--accent); font-weight: 800; text-decoration: none; }
        .notice a:hover{ text-decoration: underline; }

    </style>
</head>
<body>

  <!-- Icon sprite -->
  <svg xmlns="http://www.w3.org/2000/svg" style="position:absolute;width:0;height:0;overflow:hidden">
    <symbol id="ico-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M20 6L9 17l-5-5"/>
    </symbol>
    <symbol id="ico-x" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M18 6L6 18M6 6l12 12"/>
    </symbol>
    <symbol id="ico-shield" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.1" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 3l8 4v6c0 5-3.5 9-8 10-4.5-1-8-5-8-10V7l8-4z"/>
      <path d="M9 12l2 2 4-5"/>
    </symbol>
    <symbol id="ico-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.1" stroke-linecap="round" stroke-linejoin="round">
      <path d="M4 19V5"/>
      <path d="M4 19h16"/>
      <path d="M8 15v-4"/>
      <path d="M12 15V7"/>
      <path d="M16 15v-2"/>
    </symbol>
    <symbol id="ico-grid" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.1" stroke-linecap="round" stroke-linejoin="round">
      <path d="M4 4h7v7H4z"/>
      <path d="M13 4h7v7h-7z"/>
      <path d="M4 13h7v7H4z"/>
      <path d="M13 13h7v7h-7z"/>
    </symbol>
    <symbol id="ico-clock" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.1" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 22a10 10 0 1 0-10-10 10 10 0 0 0 10 10z"/>
      <path d="M12 6v6l4 2"/>
    </symbol>
    <symbol id="ico-bolt" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.1" stroke-linecap="round" stroke-linejoin="round">
      <path d="M13 2L3 14h7l-1 8 10-12h-7l1-8z"/>
    </symbol>
    <symbol id="ico-db" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.1" stroke-linecap="round" stroke-linejoin="round">
      <ellipse cx="12" cy="5" rx="8" ry="3"/>
      <path d="M4 5v6c0 1.7 3.6 3 8 3s8-1.3 8-3V5"/>
      <path d="M4 11v6c0 1.7 3.6 3 8 3s8-1.3 8-3v-6"/>
    </symbol>
    <symbol id="ico-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.1" stroke-linecap="round" stroke-linejoin="round">
      <path d="M5 12h12"/>
      <path d="M13 6l6 6-6 6"/>
    </symbol>
  </svg>

<div class="page">
    <header>
        <div class="badge">
            <span class="badge-dot"></span>
            Калькулятор · План и маржа по SKU
        </div>
        <h1>Калькулятор плана по SKU</h1>
        <p class="subtitle">
            Внеси фактические данные за прошлые месяцы или подтяни их из CSV, задай коэффициент месяца — и калькулятор посчитает план штук, оборот и маржу.
        </p>
    </header>

    <div class="notice">
        Нужен быстрый расчёт маржи (без планирования SKU)? 
        <a href="calc_margin.html" target="_blank" rel="noopener">Открыть калькулятор маржи</a>.
    </div>


    <main class="layout">
        <!-- Левая часть: ввод данных -->
        <section>
            <form id="planner-form" onsubmit="event.preventDefault(); calculatePlan();">
                <!-- Блок: общая информация -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">1. Общая информация</div>
                            <div class="card-caption">SKU, площадка и целевой месяц плана.</div>
                        </div>
                        <div class="pill">Step 1</div>
                    </div>
                    <div class="form-grid">
                        <div class="form-row">
                            <label for="skuName">SKU / Модель</label>
                            <input type="text" id="skuName" placeholder="Например: Storm 5800W">
                        </div>
                        <div class="form-row">
                            <label for="cabinet">Кабинет / ИП</label>
                            <input type="text" id="cabinet" placeholder="ИП Вершкова / ООО ИКС ГРОУ">
                        </div>
                        <div class="form-row">
                            <label for="marketplace">Площадка</label>
                            <select id="marketplace">
                                <option value="WB">Wildberries</option>
                                <option value="OZON">Ozon</option>
                                <option value="Both">WB + Ozon (совокупно)</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label for="targetMonth">Целевой месяц (название для отчёта)</label>
                            <input type="text" id="targetMonth" placeholder="Например: Декабрь 2025">
                        </div>
                    </div>
                </div>

                <!-- Блок: история продаж -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">2. История за последние 3 месяца</div>
                            <div class="card-caption">
                                Можно забить руками или подтянуть автоматически из <span class="mono">xgrow_history.csv</span>.
                            </div>
                        </div>
                        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
                            <div class="pill">Step 2</div>
                            <button type="button" class="btn-secondary" onclick="prefillFromHistory()">
                                Из истории CSV
                            </button>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-row">
                            <label>Месяц −3 (самый старый)</label>
                            <input type="text" id="m1Name" placeholder="Например: Сентябрь">
                            <div class="form-row">
                                <label for="m1Units">Продано, шт</label>
                                <input type="text" id="m1Units" placeholder="шт">
                            </div>
                            <div class="form-row">
                                <label for="m1Revenue">Выручка после СПП, ₽ (опц.)</label>
                                <input type="text" id="m1Revenue" placeholder="можно оставить пустым">
                            </div>
                        </div>
                        <div class="form-row">
                            <label>Месяц −2</label>
                            <input type="text" id="m2Name" placeholder="Например: Октябрь">
                            <div class="form-row">
                                <label for="m2Units">Продано, шт</label>
                                <input type="text" id="m2Units" placeholder="шт">
                            </div>
                            <div class="form-row">
                                <label for="m2Revenue">Выручка после СПП, ₽ (опц.)</label>
                                <input type="text" id="m2Revenue" placeholder="можно оставить пустым">
                            </div>
                        </div>
                        <div class="form-row">
                            <label>Месяц −1 (последний факт)</label>
                            <input type="text" id="m3Name" placeholder="Например: Ноябрь">
                            <div class="form-row">
                                <label for="m3Units">Продано, шт</label>
                                <input type="text" id="m3Units" placeholder="шт">
                            </div>
                            <div class="form-row">
                                <label for="m3Revenue">Выручка после СПП, ₽ (опц.)</label>
                                <input type="text" id="m3Revenue" placeholder="можно оставить пустым">
                            </div>
                        </div>
                        <div class="form-row">
                            <label>Настройки истории</label>
                            <div class="form-row-inline">
                                <input type="checkbox" id="isNew">
                                <label for="isNew">Новинка (нет истории, план задаём руками)</label>
                            </div>
                            <div class="form-row">
                                <label for="manualBaseUnits">Если новинка: базовый план, шт</label>
                                <input type="text" id="manualBaseUnits" placeholder="Например: 30">
                                <div class="hint">Если не новинка, это поле можно игнорировать.</div>
                            </div>
                        </div>
                    </div>
                    <p class="small-note">
                        CSV ищется по связке: <span class="mono">cabinet + mp + sku</span>,
                        где mp = WB / OZON / Both (для Both суммируются обе площадки).
                    </p>
                </div>

                <!-- Блок: коэффициенты месяца и сценарий -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">3. Коэффициент месяца и сценарий</div>
                            <div class="card-caption">
                                Сезонность и сценарий (база/опт/пессим), плюс ручной оверрайд плана штук.
                            </div>
                        </div>
                        <div class="pill">Step 3</div>
                    </div>
                    <div class="form-grid">
                        <div class="form-row">
                            <label for="kSeason">K сезона для целевого месяца</label>
                            <input type="text" id="kSeason" placeholder="1 по умолчанию">
                            <div class="hint">Например: 1.2 для декабря, 0.8 для «слабого» месяца. Из CSV берётся k_season_next последнего месяца.</div>
                        </div>
                        <div class="form-row">
                            <label for="kScenario">K сценария (База/Опт/Пессим)</label>
                            <input type="text" id="kScenario" value="1">
                            <div class="hint">1 — базовый; 1.1 — оптимист; 0.85 — пессимист.</div>
                        </div>
                        <div class="form-row">
                            <label for="planUnitsOverride">Ручной план, шт (оверрайд)</label>
                            <input type="text" id="planUnitsOverride" placeholder="оставь пустым, если доверяешь формуле">
                            <div class="hint">Если заполнишь — калькулятор возьмёт это значение вместо авторасчёта.</div>
                        </div>
                    </div>
                </div>

                <!-- Блок: цена, СПП, затраты -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">4. Цена, СПП и затраты по SKU</div>
                            <div class="card-caption">
                                Эти параметры повторяют логику P&L / BI по единице товара.
                            </div>
                        </div>
                        <div class="pill">Step 4</div>
                    </div>
                    <div class="form-grid">
                        <div class="form-row">
                            <label for="priceGross">Цена до СПП, ₽</label>
                            <input type="text" id="priceGross" placeholder="Например: 4 490">
                        </div>
                        <div class="form-row">
                            <label for="sppPercent">СПП / скидка, %</label>
                            <input type="text" id="sppPercent" placeholder="Например: 15">
                        </div>
                        <div class="form-row">
                            <label for="cogs">Себестоимость, ₽/ед</label>
                            <input type="text" id="cogs" placeholder="закупка + доставка до РФ">
                        </div>
                        <div class="form-row">
                            <label for="logStock">Логистика до склада, ₽/ед</label>
                            <input type="text" id="logStock" placeholder="средняя ставка">
                        </div>
                        <div class="form-row">
                            <label for="logClient">Логистика до клиента, ₽/ед</label>
                            <input type="text" id="logClient" placeholder="FBO/FBS">
                        </div>
                        <div class="form-row">
                            <label for="storageCost">Хранение, ₽/ед</label>
                            <input type="text" id="storageCost" placeholder="в месяц">
                        </div>
                        <div class="form-row">
                            <label for="otherVar">Прочие переменные, ₽/ед</label>
                            <input type="text" id="otherVar" placeholder="упаковка, услуги, средние штрафы">
                        </div>
                        <div class="form-row">
                            <label for="commissionPercent">Комиссия МП, %</label>
                            <input type="text" id="commissionPercent" placeholder="например: 15">
                        </div>
                        <div class="form-row">
                            <label for="returnsPercent">Возвраты, % от выручки</label>
                            <input type="text" id="returnsPercent" placeholder="например: 5">
                        </div>
                        <div class="form-row">
                            <label for="defectPercent">Брак, % по штукам</label>
                            <input type="text" id="defectPercent" placeholder="например: 2">
                        </div>
                        <div class="form-row">
                            <label for="drrPercent">Плановый ДРР, %</label>
                            <input type="text" id="drrPercent" placeholder="например: 20">
                        </div>
                        <div class="form-row">
                            <label for="taxPercent">Налог, % от прибыли</label>
                            <input type="text" id="taxPercent" placeholder="например: 6">
                        </div>
                    </div>

                    <button type="submit" class="btn-primary">Рассчитать план и маржу</button>
                    <p class="small-note">
                        Все проценты вводим как <span class="mono">15</span> = 15%, а не 0.15.
                        Разделитель для чисел — точка или запятая, пробелы можно.
                    </p>
                </div>
            </form>
        </section>

        <!-- Правая часть: результаты и расшифровка -->
        <aside>
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Итоги по SKU на месяц</div>
                        <div class="card-caption">
                            План штук, оборот и маржа по выбранному товару и месяцу.
                        </div>
                    </div>
                    <div class="pill-strong">Result</div>
                </div>

                <div class="chip-row">
                    <div class="chip">
                        База, шт: <span id="baseUnitsInfo" class="mono">0</span>
                    </div>
                    <div class="chip">
                        K тренда: <span id="trendInfo" class="mono">1.00</span>
                    </div>
                    <div class="chip">
                        Итоговый K: <span id="totalKInfo" class="mono">1.00</span>
                    </div>
                    <div class="chip">
                        Новинка: <span id="isNewInfo" class="mono">нет</span>
                    </div>
                </div>

                <div class="output-grid" style="margin-top:10px;">
                    <div class="output-row">
                        <div class="output-label">План продаж, шт</div>
                        <div class="output-value" id="outPlanUnits">0</div>
                    </div>
                    <div class="output-row">
                        <div class="output-label">Выручка до СПП, ₽</div>
                        <div class="output-value" id="outRevenueGross">0</div>
                    </div>
                    <div class="output-row">
                        <div class="output-label">Выручка после СПП и возвратов, ₽</div>
                        <div class="output-value" id="outRevenueNet">0</div>
                    </div>
                    <div class="output-row">
                        <div class="output-label">Расход на рекламу, ₽</div>
                        <div class="output-value" id="outAdSpend">0</div>
                    </div>
                    <div class="output-row">
                        <div class="output-label">Маржа, ₽</div>
                        <div class="output-value" id="outProfit">0</div>
                    </div>
                    <div class="output-row">
                        <div class="output-label">Маржа, % от выручки</div>
                        <div class="output-value" id="outMarginPercent">0%</div>
                    </div>
                    <div class="output-row">
                        <div class="output-label">Маржа, ₽/ед</div>
                        <div class="output-value" id="outProfitPerUnit">0</div>
                    </div>
                    <div class="output-row">
                        <div class="output-label">Фактический ДРР по плану</div>
                        <div class="output-value" id="outRealDRR">0%</div>
                    </div>
                </div>

                <p class="small-note">
                    Если маржа в % подсвечивается красным — ниже 0 или совсем «тонкая».
                    Можно играться ценой, K сезона, ДРР и проверять сценарии.
                </p>
            </div>

            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Формула плана штук</div>
                        <div class="card-caption">Как именно считается план по количеству.</div>
                    </div>
                    <div class="pill">Logic</div>
                </div>
                <p class="small-note">
                    Если товар не новинка:
                </p>
                <p class="small-note mono">
                    База_шт = среднее(шт_м−3, шт_м−2, шт_м−1)<br>
                    K_тренда = шт_м−1 / шт_м−2 (ограничен 0.6…1.4)<br>
                    План_шт_авто = База_шт × K_тренда × K_сезона × K_сценария
                </p>
                <p class="small-note">
                    Если стоит галочка «Новинка» — База_шт берётся из поля
                    «базовый план, шт», без учёта истории, K тренда = 1.
                </p>
                <p class="small-note">
                    Поле «Ручной план, шт» полностью перекрывает автоматический расчёт, если там не пусто.
                </p>
            </div>
        </aside>
    </main>
</div>

<script>
    // --- Глобальные данные истории из CSV ---
    let historyData = [];
    let historyLoaded = false;

    function parseNumber(value) {
        if (!value) return 0;
        value = String(value).replace(/\s+/g, "").replace(",", ".");
        const num = parseFloat(value);
        return isNaN(num) ? 0 : num;
    }

    function parsePercentInput(id) {
        const v = parseNumber(document.getElementById(id).value);
        return v / 100.0;
    }

    function formatNumber(value, decimals) {
        if (!isFinite(value)) value = 0;
        decimals = decimals === undefined ? 0 : decimals;
        const options = {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        };
        return value.toLocaleString("ru-RU", options);
    }

    // Загрузка CSV с историей
    function loadHistoryCsv() {
        fetch("data/xgrow_history.csv")
            .then(resp => {
                if (!resp.ok) throw new Error("HTTP " + resp.status);
                return resp.text();
            })
            .then(text => {
                const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0);
                if (lines.length <= 1) return;

                const header = lines[0].split(";");
                const idxCabinet = header.indexOf("cabinet");
                const idxMp = header.indexOf("mp");
                const idxSku = header.indexOf("sku");
                const idxMonth = header.indexOf("month");
                const idxUnits = header.indexOf("units");
                const idxRevenue = header.indexOf("revenue_net");
                const idxKSeasonNext = header.indexOf("k_season_next");

                historyData = lines.slice(1).map(line => {
                    const cols = line.split(";");
                    return {
                        cabinet: (cols[idxCabinet] || "").trim(),
                        mp: (cols[idxMp] || "").trim(),
                        sku: (cols[idxSku] || "").trim(),
                        month: (cols[idxMonth] || "").trim(), // формат YYYY-MM
                        units: parseNumber(cols[idxUnits] || ""),
                        revenueNet: parseNumber(cols[idxRevenue] || ""),
                        kSeasonNext: idxKSeasonNext >= 0 ? parseNumber(cols[idxKSeasonNext] || "") : 0
                    };
                });

                historyLoaded = true;
                console.log("История загружена, строк:", historyData.length);
            })
            .catch(err => {
                console.warn("Не удалось загрузить data/xgrow_history.csv:", err);
            });
    }

    // Автозаполнение истории из CSV
    function prefillFromHistory() {
        if (!historyLoaded || historyData.length === 0) {
            alert("История из CSV ещё не загружена или файл пуст. Проверь, что data/xgrow_history.csv доступен.");
            return;
        }

        const cabinet = document.getElementById("cabinet").value.trim();
        const mp = document.getElementById("marketplace").value;
        const sku = document.getElementById("skuName").value.trim();

        if (!cabinet || !sku) {
            alert("Заполни поля «SKU / Модель» и «Кабинет / ИП», чтобы поискать данные в CSV.");
            return;
        }

        let filtered = historyData.filter(row =>
            row.cabinet === cabinet &&
            row.sku === sku
        );

        if (mp !== "Both") {
            filtered = filtered.filter(row => row.mp === mp);
        }

        if (filtered.length === 0) {
            alert("В CSV не найдены строки с таким кабинетом / SKU / площадкой.");
            return;
        }

        // Сортируем по месяцу и берём последние 3
        filtered.sort((a, b) => a.month.localeCompare(b.month));
        const last3 = filtered.slice(-3);

        // Очищаем сначала поля
        ["m1Name","m2Name","m3Name","m1Units","m2Units","m3Units","m1Revenue","m2Revenue","m3Revenue"]
            .forEach(id => document.getElementById(id).value = "");

        function setMonthFields(pos, row) {
            const nameId = "m" + pos + "Name";
            const unitsId = "m" + pos + "Units";
            const revId = "m" + pos + "Revenue";
            document.getElementById(nameId).value = row.month;
            document.getElementById(unitsId).value = row.units > 0 ? row.units : "";
            if (row.revenueNet > 0) {
                document.getElementById(revId).value = row.revenueNet;
            }
        }

        // заполняем начиная с самого старого из last3
        const startPos = 4 - last3.length; // чтобы при 1 строке она попала в m3, при 2 — m2/m3, при 3 — m1/m2/m3
        last3.forEach((row, idx) => {
            setMonthFields(startPos + idx, row);
        });

        // K сезона подтягиваем из k_season_next последнего месяца
        const lastRow = last3[last3.length - 1];
        if (lastRow && lastRow.kSeasonNext > 0) {
            document.getElementById("kSeason").value = lastRow.kSeasonNext;
        }
    }

    function calculatePlan() {
        // История
        const isNew = document.getElementById("isNew").checked;
        const m1Units = parseNumber(document.getElementById("m1Units").value);
        const m2Units = parseNumber(document.getElementById("m2Units").value);
        const m3Units = parseNumber(document.getElementById("m3Units").value);

        let baseUnits = 0;
        let trendK = 1;

        if (!isNew) {
            const hist = [m1Units, m2Units, m3Units].filter(v => v > 0);
            if (hist.length > 0) {
                const sum = hist.reduce((a, b) => a + b, 0);
                baseUnits = sum / hist.length;
            }
            if (m2Units > 0 && m3Units > 0) {
                trendK = m3Units / m2Units;
                if (trendK < 0.6) trendK = 0.6;
                if (trendK > 1.4) trendK = 1.4;
            }
        } else {
            baseUnits = parseNumber(document.getElementById("manualBaseUnits").value);
            trendK = 1;
        }

        let kSeason = parseNumber(document.getElementById("kSeason").value || "1");
        if (kSeason <= 0) kSeason = 1;
        let kScenario = parseNumber(document.getElementById("kScenario").value || "1");
        if (kScenario <= 0) kScenario = 1;

        const totalK = trendK * kSeason * kScenario;

        const planUnitsAuto = baseUnits * totalK;
        const planUnitsOverride = parseNumber(document.getElementById("planUnitsOverride").value);
        let planUnits = planUnitsOverride > 0 ? planUnitsOverride : Math.round(planUnitsAuto);
        if (!isFinite(planUnits) || planUnits < 0) planUnits = 0;

        // Цена и проценты
        const priceGross = parseNumber(document.getElementById("priceGross").value);
        const spp = parsePercentInput("sppPercent");
        const cogs = parseNumber(document.getElementById("cogs").value);
        const logStock = parseNumber(document.getElementById("logStock").value);
        const logClient = parseNumber(document.getElementById("logClient").value);
        const storageCost = parseNumber(document.getElementById("storageCost").value);
        const otherVar = parseNumber(document.getElementById("otherVar").value);
        const commissionP = parsePercentInput("commissionPercent");
        const returnsP = parsePercentInput("returnsPercent");
        const defectP = parsePercentInput("defectPercent");
        const drrP = parsePercentInput("drrPercent");
        const taxP = parsePercentInput("taxPercent");

        // Планы по выручке
        const revenueGross = planUnits * priceGross;
        const sppRub = revenueGross * spp;
        const revenueAfterSPP = revenueGross - sppRub;
        const returnsRub = revenueAfterSPP * returnsP;
        const revenueNet = revenueAfterSPP - returnsRub;

        // Брак по штукам (списываем себестоимость брака)
        const defectUnits = planUnits * defectP;
        const goodUnits = planUnits - defectUnits;
        if (goodUnits < 0) goodUnits = 0;

        // Переменные затраты
        const cogsTotal = planUnits * cogs;
        const logStockTotal = planUnits * logStock;
        const logClientTotal = planUnits * logClient;
        const storageTotal = planUnits * storageCost;
        const otherVarTotal = planUnits * otherVar;
        const commissionTotal = revenueAfterSPP * commissionP;

        // Валовая прибыль до маркетинга
        const grossProfitBeforeMkt =
            revenueNet -
            cogsTotal -
            logStockTotal -
            logClientTotal -
            storageTotal -
            otherVarTotal -
            commissionTotal;

        // Реклама
        const adSpend = revenueNet * drrP;
        const profitBeforeTax = grossProfitBeforeMkt - adSpend;

        // Налоги
        const tax = profitBeforeTax * taxP;
        const netProfit = profitBeforeTax - tax;

        // KPI
        const marginPercent = revenueNet > 0 ? (netProfit / revenueNet) * 100 : 0;
        const profitPerUnit = planUnits > 0 ? netProfit / planUnits : 0;
        const realDRR = revenueNet > 0 ? (adSpend / revenueNet) * 100 : 0;

        // Обновляем UI
        document.getElementById("baseUnitsInfo").textContent = formatNumber(baseUnits, 1);
        document.getElementById("trendInfo").textContent = formatNumber(trendK, 2);
        document.getElementById("totalKInfo").textContent = formatNumber(totalK, 2);
        document.getElementById("isNewInfo").textContent = isNew ? "да" : "нет";

        document.getElementById("outPlanUnits").textContent = formatNumber(planUnits, 0);
        document.getElementById("outRevenueGross").textContent = formatNumber(revenueGross, 0);
        document.getElementById("outRevenueNet").textContent = formatNumber(revenueNet, 0);
        document.getElementById("outAdSpend").textContent = formatNumber(adSpend, 0);
        document.getElementById("outProfit").textContent = formatNumber(netProfit, 0);
        document.getElementById("outMarginPercent").textContent = formatNumber(marginPercent, 1) + " %";
        document.getElementById("outProfitPerUnit").textContent = formatNumber(profitPerUnit, 0);
        document.getElementById("outRealDRR").textContent = formatNumber(realDRR, 1) + " %";

        // Подсветка маржи
        const marginEl = document.getElementById("outMarginPercent");
        marginEl.classList.remove("bad", "good");
        if (marginPercent < 0) {
            marginEl.classList.add("bad");
        } else if (marginPercent >= 20) {
            marginEl.classList.add("good");
        }
    }

    document.addEventListener("DOMContentLoaded", loadHistoryCsv);
</script>
</body>
</html>
